(function(){var c={containerClass:"concurrency",takeLocalButtonTitle:"Take local",takeLocalButtonClassName:"take-local",takeRemoteButtonTitle:"Take server",takeRemoteButtonClass:"take-server",itemAddedCaption:"Added",itemDeletedCaption:"Deleted",autoInjectViewForArrays:true};ko.concurrency=(function(){return{init:function(e){e=e||{};c=ko.utils.extend(c,e)},bindingOverrides:{value:true,checked:true}}}());var d=(function(){return{conflictResolvers:{itemAdded:{takeServer:function(){},takeLocal:function(e){d.removeConcurrencyItem(e)}},itemDeleted:{takeServer:function(e){d.removeConcurrencyItem(e)},takeLocal:function(){}},value:{takeServer:function(e){e.currentValue(e.otherValue())},takeLocal:function(){}}},removeConcurrencyItem:function(e){e.array.remove(function(f){return f.concurrency()==e})},extendObservableArray:function(e,f){e.concurrencyExtendOptions=f;e.subscribe(function(g){ko.utils.arrayForEach(g,function(h){if(h.concurrency==null){d.concurrencyExtendObservable(h,f,e)}})})},concurrencyExtendObservable:function(f,g,e){f.concurrency=ko.observable(new ko.concurrency.ConcurrencyViewModel(false,null,f,g,e))},registerBindingOverrides:function(){for(var e in ko.concurrency.bindingOverrides){if(ko.concurrency.bindingOverrides[e]){d.registerBindingOverride(e)}}d.overrideTemplateBinding()},registerBindingOverride:function(g){var e=ko.bindingHandlers[g];var f=e.init;e.init=function(k,m,h,n,i){if(f){f(k,m,h,n,i)}var l=m();if(l.concurrency){var j=document.createElement("SPAN");k.parentNode.insertBefore(j,k.nextSibling);ko.applyBindingsToNode(j,{concurrency:l.concurrency})}}},renderConcurrencyView:function(f,e){var k=ko.utils.unwrapObservable(e());var g=k.options;var h=document.createElement("SPAN");var j=document.createElement("BUTTON");var i=document.createElement("BUTTON");ko.utils.registerEventHandler(i,"click",function(){k.takeLocal()});ko.utils.registerEventHandler(j,"click",function(){k.takeServer()});f.className=g.containerClass;i.title=g.takeLocalButtonTitle;i.className=g.takeLocalButtonClassName;j.title=g.takeRemoteButtonTitle;j.className=g.takeRemoteButtonClass;f.appendChild(h);f.appendChild(j);f.appendChild(i);ko.applyBindingsToNode(f,{visible:k.conflict});ko.applyBindingsToNode(h,{concurrencyValue:k})},overrideTemplateBinding:function(){var e=ko.bindingHandlers.foreach;var f=e.init;e.init=function(j,k,g,l,i){if(k().concurrencyExtendOptions){if(k().concurrencyExtendOptions.autoInjectViewForArrays){var h=document.createElement("SPAN");h.setAttribute("data-bind","concurrency: concurrency");j.appendChild(h)}}return f(j,k,g,l,i)}},extendLiteral:function(g,f){for(var e in f){if(g[e]==null){g[e]=f[e]}}return g}}}());ko.concurrency.ConcurrencyViewModel=function(f,i,g,h,e){this.options=h;this.resolved=ko.observable(false);this.conflict=ko.observable(f);this.otherValue=ko.observable(i);this.currentValue=g;this.array=e};ko.concurrency.ConcurrencyViewModel.prototype={resolve:function(){this.resolved(true);this.conflict(false);this.runner.removeConflict(this)},takeLocal:function(){this.resolve();this.resolver.takeLocal(this)},takeServer:function(){this.resolve();this.resolver.takeServer(this)}};ko.extenders.concurrency=function(f,e){if(e==true){e={}}e=d.extendLiteral(e,c);if(f.push){d.extendObservableArray(f,e)}else{d.concurrencyExtendObservable(f,e)}return f};ko.bindingHandlers.concurrency={init:function(e,f){d.renderConcurrencyView(e,f)}};ko.bindingHandlers.concurrencyValue={update:function(f,h){var e=ko.utils.unwrapObservable(h());var g=e.options.presenter?function(){return e.options.presenter(e.otherValue())}:e.otherValue;ko.bindingHandlers.text.update(f,g)}};ko.concurrency.Runner=function(e){if(e!=null){this.conflicts=ko.observableArray();e.concurrencyConflicts=this.conflicts}};ko.concurrency.Runner.prototype={run:function(x,y,s){if(y==null){return false}for(var k in x){var p=x[k];var q=y[k];var o=p.concurrency;var r=s?s[k]:null;if(ko.isObservable(p)&&!p.push){var v=ko.utils.unwrapObservable(p);var w=ko.utils.unwrapObservable(q);if(this.isComplex(v)){this.run(v,w,r)}else{if(o!=null){this.compareAndNotify(v,w,o)}}}else{if(p.push){var t=p;var e=ko.utils.unwrapObservable(p);var f=ko.utils.unwrapObservable(q);if(f!=null){if(r==null){for(var h in e){if(f[h]!=null){this.run(e[h],f[h],r)}}}else{var u={};for(var h in e){var g=false;var n=r.key(e[h]);var l=e[h];for(var m in f){if(n==r.key(f[m])){this.run(l,f[m],r);g=true;continue}}if(!g&&l.concurrency){this.itemDeleted(l,r)}u[r.key(e[h])]=true}for(var h in f){l=f[h];if(!u[r.key(l)]&&t.concurrencyExtendOptions){this.itemAdded(t,l,r)}}}}}else{if(this.isComplex(p)&&p.$constructor==null){this.run(p,q,r)}else{if(o!=null){this.compareAndNotify(p,q,o)}}}}}},takeServer:function(){var e=ko.utils.unwrapObservable(this.conflicts);while(e.length>0){e[0].takeServer()}},isComplex:function(e){return e instanceof Object},itemAdded:function(e,f,g){var i=e.concurrencyExtendOptions?e.concurrencyExtendOptions:c;var h=g.create(f);e.push(h);this.notify(true,i.itemAddedCaption,d.conflictResolvers.itemAdded,h.concurrency)},itemDeleted:function(e,f){if(f.deleted){f.deleted(e)}this.notify(true,e.concurrency().options.itemDeletedCaption,d.conflictResolvers.itemDeleted,e.concurrency)},compareAndNotify:function(g,h,f){var e=g!=h;this.notify(e,h,d.conflictResolvers.value,f)},notify:function(e,i,g,f){var h=f();h.conflict(e);h.resolved(!e);h.otherValue(i);h.runner=this;h.resolver=g;this.updateConflictList(h)},updateConflictList:function(e){if(this.conflicts!=null){this.conflicts.remove(e);if(e.conflict()){this.conflicts.push(e)}}},removeConflict:function(e){if(this.conflicts!=null){this.conflicts.remove(e)}}};var b=false;var a=ko.applyBindings;ko.applyBindings=function(e,f){if(!b){d.registerBindingOverrides();b=true}a(e,f)}}());